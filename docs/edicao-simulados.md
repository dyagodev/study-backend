# üìù Edi√ß√£o Completa de Simulados

## üéØ Funcionalidades Implementadas

Sistema completo para edi√ß√£o de simulados, incluindo:
- ‚úÖ Editar informa√ß√µes b√°sicas (t√≠tulo, descri√ß√£o, etc.)
- ‚úÖ Substituir todas as quest√µes de uma vez
- ‚úÖ Adicionar quest√£o individual
- ‚úÖ Remover quest√£o individual
- ‚úÖ Reordenar quest√µes

---

## üì° Endpoints da API

### 1. Atualizar Simulado Completo

Atualiza informa√ß√µes b√°sicas e/ou substitui todas as quest√µes.

**PUT** `/api/simulados/{id}`

#### Request Body

```json
{
  "titulo": "Simulado Atualizado",
  "descricao": "Nova descri√ß√£o",
  "tempo_limite": 90,
  "embaralhar_questoes": true,
  "mostrar_gabarito": false,
  "status": "ativo",
  "questoes": [
    {
      "questao_id": 1,
      "pontuacao": 2.0
    },
    {
      "questao_id": 3,
      "pontuacao": 1.5
    },
    {
      "questao_id": 5,
      "pontuacao": 1.0
    }
  ]
}
```

#### Campos

| Campo | Tipo | Obrigat√≥rio | Descri√ß√£o |
|-------|------|-------------|-----------|
| titulo | string | N√£o | T√≠tulo do simulado (m√°x 255) |
| descricao | string | N√£o | Descri√ß√£o do simulado |
| tempo_limite | integer | N√£o | Tempo em minutos |
| embaralhar_questoes | boolean | N√£o | Embaralhar ao iniciar |
| mostrar_gabarito | boolean | N√£o | Mostrar gabarito ao final |
| status | string | N√£o | rascunho, ativo, arquivado |
| questoes | array | N√£o* | Lista de quest√µes do simulado |
| questoes[].questao_id | integer | Sim** | ID da quest√£o |
| questoes[].pontuacao | numeric | N√£o | Pontua√ß√£o (padr√£o: 1.0) |

*Se `questoes` for enviado, **todas** as quest√µes antigas ser√£o substitu√≠das pelas novas.  
**Obrigat√≥rio se `questoes` for enviado.

#### Response Success (200)

```json
{
  "success": true,
  "message": "Simulado atualizado com sucesso",
  "data": {
    "id": 1,
    "titulo": "Simulado Atualizado",
    "descricao": "Nova descri√ß√£o",
    "tempo_limite": 90,
    "embaralhar_questoes": true,
    "mostrar_gabarito": false,
    "status": "ativo",
    "questoes": [
      {
        "id": 1,
        "enunciado": "Quest√£o 1...",
        "pivot": {
          "ordem": 1,
          "pontuacao": 2.0
        }
      }
      // ... mais quest√µes
    ]
  }
}
```

#### Response Error (403)

```json
{
  "success": false,
  "message": "Voc√™ s√≥ pode adicionar quest√µes que voc√™ criou"
}
```

---

### 2. Adicionar Quest√£o Individual

Adiciona uma quest√£o ao final do simulado.

**POST** `/api/simulados/{id}/questoes`

#### Request Body

```json
{
  "questao_id": 7,
  "pontuacao": 1.5
}
```

#### Campos

| Campo | Tipo | Obrigat√≥rio | Descri√ß√£o |
|-------|------|-------------|-----------|
| questao_id | integer | Sim | ID da quest√£o a adicionar |
| pontuacao | numeric | N√£o | Pontua√ß√£o (padr√£o: 1.0) |

#### Response Success (200)

```json
{
  "success": true,
  "message": "Quest√£o adicionada ao simulado",
  "data": {
    "id": 1,
    "titulo": "Meu Simulado",
    "questoes": [
      // ... quest√µes existentes
      {
        "id": 7,
        "enunciado": "Nova quest√£o...",
        "pivot": {
          "ordem": 4,
          "pontuacao": 1.5
        }
      }
    ]
  }
}
```

#### Response Error (422)

```json
{
  "success": false,
  "message": "Esta quest√£o j√° est√° no simulado"
}
```

---

### 3. Remover Quest√£o Individual

Remove uma quest√£o espec√≠fica do simulado e reordena as demais.

**DELETE** `/api/simulados/{id}/questoes/{questaoId}`

#### Response Success (200)

```json
{
  "success": true,
  "message": "Quest√£o removida do simulado",
  "data": {
    "id": 1,
    "titulo": "Meu Simulado",
    "questoes": [
      // Quest√µes restantes, reordenadas
    ]
  }
}
```

#### Response Error (404)

```json
{
  "success": false,
  "message": "Esta quest√£o n√£o est√° no simulado"
}
```

---

### 4. Reordenar Quest√µes

Reordena as quest√µes do simulado.

**PUT** `/api/simulados/{id}/questoes/reordenar`

#### Request Body

```json
{
  "questoes": [
    {
      "questao_id": 5,
      "ordem": 1
    },
    {
      "questao_id": 3,
      "ordem": 2
    },
    {
      "questao_id": 1,
      "ordem": 3
    }
  ]
}
```

#### Campos

| Campo | Tipo | Obrigat√≥rio | Descri√ß√£o |
|-------|------|-------------|-----------|
| questoes | array | Sim | Lista completa com novas ordens |
| questoes[].questao_id | integer | Sim | ID da quest√£o |
| questoes[].ordem | integer | Sim | Nova ordem (1, 2, 3...) |

#### Response Success (200)

```json
{
  "success": true,
  "message": "Quest√µes reordenadas com sucesso",
  "data": {
    "id": 1,
    "titulo": "Meu Simulado",
    "questoes": [
      {
        "id": 5,
        "pivot": {
          "ordem": 1
        }
      },
      {
        "id": 3,
        "pivot": {
          "ordem": 2
        }
      },
      {
        "id": 1,
        "pivot": {
          "ordem": 3
        }
      }
    ]
  }
}
```

---

## üîí Seguran√ßa

### Valida√ß√µes Implementadas

1. **Propriedade do Simulado**
   - Usu√°rio s√≥ pode editar simulados que criou
   - Retorna 403 se tentar editar simulado de outro usu√°rio

2. **Propriedade das Quest√µes**
   - Usu√°rio s√≥ pode adicionar quest√µes que criou
   - Sistema valida `user_id` de cada quest√£o
   - Retorna 403 se tentar adicionar quest√£o de outro usu√°rio

3. **Duplica√ß√£o**
   - N√£o permite adicionar quest√£o j√° existente no simulado
   - Retorna 422 se tentar duplicar

4. **Exist√™ncia**
   - Valida que quest√µes existem no banco
   - Valida que quest√µes est√£o no simulado (ao remover/reordenar)

---

## üí° Exemplos de Uso

### Exemplo 1: Atualizar Apenas o T√≠tulo

```bash
curl -X PUT http://localhost/api/simulados/1 \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "titulo": "Novo T√≠tulo"
  }'
```

### Exemplo 2: Substituir Todas as Quest√µes

```bash
curl -X PUT http://localhost/api/simulados/1 \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "questoes": [
      {"questao_id": 10, "pontuacao": 2.0},
      {"questao_id": 11, "pontuacao": 1.5},
      {"questao_id": 12, "pontuacao": 1.0}
    ]
  }'
```

### Exemplo 3: Adicionar Uma Quest√£o

```bash
curl -X POST http://localhost/api/simulados/1/questoes \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "questao_id": 15,
    "pontuacao": 1.5
  }'
```

### Exemplo 4: Remover Uma Quest√£o

```bash
curl -X DELETE http://localhost/api/simulados/1/questoes/15 \
  -H "Authorization: Bearer {token}"
```

### Exemplo 5: Reordenar Quest√µes (Drag & Drop)

```bash
curl -X PUT http://localhost/api/simulados/1/questoes/reordenar \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "questoes": [
      {"questao_id": 12, "ordem": 1},
      {"questao_id": 10, "ordem": 2},
      {"questao_id": 11, "ordem": 3}
    ]
  }'
```

---

## üé® Frontend - Fluxos de UX

### Fluxo 1: Editar Simulado (Modal/P√°gina)

```javascript
// 1. Carregar simulado atual
const simulado = await api.get(`/simulados/${id}`);

// 2. Usu√°rio edita campos
const dadosAtualizados = {
  titulo: "Novo t√≠tulo",
  descricao: "Nova descri√ß√£o",
  tempo_limite: 120
};

// 3. Salvar altera√ß√µes
await api.put(`/simulados/${id}`, dadosAtualizados);
```

### Fluxo 2: Gerenciar Quest√µes (Lista Interativa)

```javascript
// Carregar simulado com quest√µes
const simulado = await api.get(`/simulados/${id}`);
const questoes = simulado.data.questoes;

// Adicionar quest√£o (bot√£o + modal de sele√ß√£o)
async function adicionarQuestao(questaoId) {
  await api.post(`/simulados/${id}/questoes`, {
    questao_id: questaoId,
    pontuacao: 1.0
  });
  recarregarSimulado();
}

// Remover quest√£o (bot√£o X na lista)
async function removerQuestao(questaoId) {
  if (confirm('Remover esta quest√£o?')) {
    await api.delete(`/simulados/${id}/questoes/${questaoId}`);
    recarregarSimulado();
  }
}

// Reordenar quest√µes (drag & drop)
async function salvarNovaOrdem(questoesReordenadas) {
  const payload = {
    questoes: questoesReordenadas.map((q, index) => ({
      questao_id: q.id,
      ordem: index + 1
    }))
  };
  
  await api.put(`/simulados/${id}/questoes/reordenar`, payload);
}
```

### Fluxo 3: Substituir Todas as Quest√µes

```javascript
// Substituir completamente a lista de quest√µes
async function substituirQuestoes(novasQuestoes) {
  await api.put(`/simulados/${id}`, {
    questoes: novasQuestoes.map((q, index) => ({
      questao_id: q.id,
      pontuacao: q.pontuacao || 1.0
    }))
  });
}
```

---

## üîÑ Comportamentos Importantes

### 1. Atualiza√ß√£o Parcial vs Completa

```javascript
// ‚úÖ Atualizar APENAS o t√≠tulo (quest√µes n√£o s√£o tocadas)
PUT /api/simulados/1
{ "titulo": "Novo t√≠tulo" }

// ‚úÖ Atualizar t√≠tulo E substituir quest√µes
PUT /api/simulados/1
{
  "titulo": "Novo t√≠tulo",
  "questoes": [...]
}

// ‚ö†Ô∏è Enviar array vazio remove TODAS as quest√µes!
PUT /api/simulados/1
{ "questoes": [] }
// Retorna erro: min:1
```

### 2. Reordena√ß√£o Autom√°tica

```javascript
// Ao remover uma quest√£o, as demais s√£o reordenadas automaticamente
DELETE /api/simulados/1/questoes/5

// Antes: [1, 5, 7] (ordens: 1, 2, 3)
// Depois: [1, 7] (ordens: 1, 2) ‚Üê reordenado automaticamente
```

### 3. Valida√ß√£o de Propriedade

```javascript
// ‚ùå Tentando adicionar quest√£o de outro usu√°rio
POST /api/simulados/1/questoes
{ "questao_id": 999 } // Quest√£o do usu√°rio B

// Response: 403 Forbidden
{
  "success": false,
  "message": "Voc√™ s√≥ pode adicionar quest√µes que voc√™ criou"
}
```

---

## üß™ Testes

### Teste 1: Editar Informa√ß√µes B√°sicas

```php
$simulado = Simulado::factory()->create(['user_id' => $user->id]);

$response = $this->putJson("/api/simulados/{$simulado->id}", [
    'titulo' => 'T√≠tulo Editado',
    'tempo_limite' => 90
]);

$response->assertStatus(200);
$this->assertEquals('T√≠tulo Editado', $simulado->fresh()->titulo);
```

### Teste 2: Adicionar Quest√£o

```php
$simulado = Simulado::factory()->create(['user_id' => $user->id]);
$questao = Questao::factory()->create(['user_id' => $user->id]);

$response = $this->postJson("/api/simulados/{$simulado->id}/questoes", [
    'questao_id' => $questao->id,
    'pontuacao' => 2.0
]);

$response->assertStatus(200);
$this->assertTrue($simulado->questoes->contains($questao));
```

### Teste 3: Remover Quest√£o

```php
$simulado = Simulado::factory()->hasAttached($questao)->create();

$response = $this->deleteJson("/api/simulados/{$simulado->id}/questoes/{$questao->id}");

$response->assertStatus(200);
$this->assertFalse($simulado->fresh()->questoes->contains($questao));
```

### Teste 4: N√£o Pode Adicionar Quest√£o de Outro Usu√°rio

```php
$simulado = Simulado::factory()->create(['user_id' => $user1->id]);
$questaoOutro = Questao::factory()->create(['user_id' => $user2->id]);

$response = $this->postJson("/api/simulados/{$simulado->id}/questoes", [
    'questao_id' => $questaoOutro->id
]);

$response->assertStatus(403);
```

---

## üìä Diagrama de Fluxo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Editar Simulado                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                   ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Dados ‚îÇ         ‚îÇ Quest√µes ‚îÇ
    ‚îÇB√°sicos‚îÇ         ‚îÇ          ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                  ‚îÇ
        ‚îÇ      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ      ‚îÇ                       ‚îÇ
        ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
        ‚îÇ  ‚îÇAdicionar‚îÇ  ‚îÇRemover     ‚îÇ  ‚îÇ
        ‚îÇ  ‚îÇUma     ‚îÇ  ‚îÇUma         ‚îÇ  ‚îÇ
        ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
        ‚îÇ      ‚îÇ              ‚îÇ        ‚îÇ
        ‚îÇ      ‚îÇ      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
        ‚îÇ      ‚îÇ      ‚îÇReordenar    ‚îÇ  ‚îÇ
        ‚îÇ      ‚îÇ      ‚îÇ(Drag&Drop)  ‚îÇ  ‚îÇ
        ‚îÇ      ‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
        ‚îÇ      ‚îÇ              ‚îÇ        ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ Valida√ß√µes:    ‚îÇ
              ‚îÇ - Propriedade  ‚îÇ
              ‚îÇ - Exist√™ncia   ‚îÇ
              ‚îÇ - Duplica√ß√£o   ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ Salvar no DB   ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ Retornar       ‚îÇ
              ‚îÇ Simulado       ‚îÇ
              ‚îÇ Atualizado     ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ Checklist de Implementa√ß√£o

- [x] M√©todo `update()` com suporte a quest√µes
- [x] M√©todo `adicionarQuestao()`
- [x] M√©todo `removerQuestao()`
- [x] M√©todo `reordenarQuestoes()`
- [x] Valida√ß√£o de propriedade em todos os m√©todos
- [x] Valida√ß√£o de quest√µes do usu√°rio
- [x] Reordena√ß√£o autom√°tica ao remover
- [x] Rotas adicionadas em `api.php`
- [x] Documenta√ß√£o completa
- [ ] Testes unit√°rios
- [ ] Testes de integra√ß√£o
- [ ] Implementa√ß√£o no frontend

---

## üöÄ Status

**‚úÖ BACKEND 100% IMPLEMENTADO**

- Data: 18/10/2025
- Vers√£o: 2.2
- Status: Pronto para integra√ß√£o frontend

---

**Pr√≥ximos Passos:**
1. Implementar interface de edi√ß√£o no frontend
2. Adicionar drag & drop para reordena√ß√£o
3. Criar modal de sele√ß√£o de quest√µes
4. Testes E2E
